# 研修カレンダー自動化システム実装 TODOリスト

## 実装詳細

### 1️⃣ 環境設定 (Environment Setup)
- [x] 1-1.Google Workspace APIの有効化
    - [x] 1-1-1.Google Calendar API
    - [x] 1-1-2.Google Sheets API
    - [x] 1-1-3.Gmail API (通知用)
- [x] 1-2.スプレッドシートの準備
    - [x] 1-2-1.**入社者連携シート**の作成
        - `入社者氏名`
        - `入社日`
        - `メールアドレス`
        - `役職レベル`
        - `処理状況`
    - [x] 1-2-2.**ONB管理表 (研修マスターシート)** の作成
        - `研修名称`
        - `研修対象者（役職）`
        - `実施タイミング`
        - `担当者・講師`
        - `講師メールアドレス`
        - `会議室名・リソースID`
    - [x] 1-2-3.**設定・ログシート**の作成
        - `実行日時`
        - `処理結果`
        - `詳細メッセージ`

### 2️⃣ GASスクリプト実装 (GAS Script Implementation)
- [x] 2-1.カレンダー検索の修正（カレンダーIDを利用）
- [x] 2-2.実施順のロジック修正
　➡カレンダー登録において、営業日のロジックはあっているが、研修登録順番が正しくない（現状のロジックをちゃんと見直して修正したい）
- [x] 2-3.職位ロジックの修正（SはパターンCのみ）
　➡入社リストで職位Sの人は、研修マスタのパターンCのみにマッチするようにロジック変更
- [x] 2-4.実行シートへの入社日記入
- [x] 2-5.研修管理表マスタの講師情報拡張対応
    - [x] 2-5-1.カラム構成の変更
        - [x] 2-5-1-1.現在のL~N列を「講師1」関連情報に変更
            - 講師1:担当者
            - 講師1:メールアドレス用略称
            - 講師1:メールアドレス
        - [x] 2-5-1-2.O~Q列に「講師2」関連情報を追加
            - 講師2:担当者
            - 講師2:メールアドレス用略称
            - 講師2:メールアドレス
        - [x] 2-5-1-3.会議室要否以降のカラムの位置調整
    - [x] 2-5-2.参加人数計算ロジックの修正（講師2人対応）
    - [x] 2-5-3.マッピング結果の講師メールアドレス表示形式変更
        - [x] 2-5-3-1.複数講師が存在する場合、メールアドレスを改行区切りで表示
- [x] 2-6.入社日に基づく研修マスタの参照（H列・J列）
- [x] 2-7.~~1日、15日の扱いの検討~~
- [x] 2-8.マッピング結果シートの表示改善
    - [x] 2-8-1.各列の幅をコンテンツに合わせて最適化
    - [x] 2-8-2.動的な行の高さ調整（複数行コンテンツに対応）
    - [x] 2-8-3.列の固定機能（研修名列を固定）
- [x] 2-9.昼休み時間帯の除外（12:00-13:00）
    - [x] 2-9-1.カレンダー登録において、12:00-13:00の時間帯を除外してスケジューリング
- [x] 2-10.旧形式ロジックの削除とコード整理
    - [x] 2-10-1.会議室要否判定の旧形式（O列）ロジックを削除し、R列固定に統一
- [x] 2-11.**メイン処理 (`executeONBAutomation`)**
    - [x] 2-11-1.`executeONBAutomation` 関数の基本構造を実装
    - [x] 2-11-2.入社者連携シートから未処理のデータを読み込むロジックを実装
    - [x] 2-11-3.各入社者に対して処理を行うループを実装
- [x] 2-12.**ユーティリティ関数 (Utility Functions)**
    - [x] 2-12-1.`getRequiredTrainings(role)`: ONB管理表から役職に応じた研修リスト（講師情報含む）を取得する関数を実装
    - [x] 2-12-2.`createCalendarInvitation(employee, training)`: カレンダーイベントを作成し、入社者、講師を招待し、会議室を予約する関数を実装
    - [x] 2-12-3.`updateStatus(row, status)`: 入社者連携シートのステータスを更新する関数を実装
    - [x] 2-12-4.`logExecution(status, message)`: ログシートに実行結果を記録する関数を実装
- [x] 2-13.**エラーハンドリング (Error Handling)**
    - [x] 2-13-1.メイン処理に `try-catch` ブロックを実装し、各入社者の処理を個別に行う
    - [x] 2-13-2.`handleError(error, employee)`: エラー内容をログに記録し、該当者のステータスを「エラー」に更新する関数を実装
    - [x] 2-13-3.エラー発生時にGmailで担当者に通知する機能（オプション）
- [x] 2-14.**UI連携 (UI Integration)**
    - [x] 2-14-1.スプレッドシートに「実行」ボタンを配置
    - [x] 2-14-2.ボタンに `executeONBAutomation` 関数を割り当てる
- [ ] 2-15.会議室収容人数対応
    - [ ] 2-15-1.参加人数が会議室の収容人数を超える場合のハイブリッド形式対応
        - [ ] 2-15-1-1.最大収容人数の会議室を確保
        - [ ] 2-15-1-2.カレンダー招待にオンライン参加のためのMeet URLを自動追加
    - [ ] 2-15-2.会議室収容人数チェックロジックの実装
    - [ ] 2-15-3.ハイブリッド開催時のメモ記入を不要にする
        - [ ] 2-15-3-1.以下のメモを削除：
            - 【ハイブリッド開催】
            - この研修はオンラインとのハイブリッド形式で実施します。
            - 会議室参加可能人数: X名
            - オンライン参加: Y名
    - [ ] 2-15-4.入社者8名超え時の会議室確保
        - [ ] 2-15-4-1.入社者が8人を超える場合、必ず8名用の会議室を確保するロジック実装
- [x] 2-16.入社者リストシートの構造修正
    - [x] 2-16-1.D列(メールアドレス用略称)を削除
    - [x] 2-16-2.所属列の右に「入社日」列を追加
    - [x] 2-16-3.入社日が記入されている場合のみ対象とするロジック実装

### 3️⃣ セキュリティと権限設定
- [ ] 3-1.スプレッドシートの共有設定を行い、アクセスを関係者に限定
- [ ] 3-2.GASプロジェクトの `appsscript.json` に必要なOAuthスコープを定義
    - [ ] 3-2-1.`https://www.googleapis.com/auth/calendar`
    - [ ] 3-2-2.`https://www.googleapis.com/auth/spreadsheets`
    - [ ] 3-2-3.`https://www.googleapis.com/auth/gmail.send` (通知機能実装時)

### 4️⃣ 運用・保守
- [ ] 4-1.運用マニュアルの作成
    - [ ] 4-1-1.処理の実行手順
    - [ ] 4-1-2.ログの確認方法
    - [ ] 4-1-3.エラー発生時の対応手順
- [ ] 4-2.マスターデータ（ONB管理表）のメンテナンス手順を定義
- [ ] 4-3.システム停止時の代替手動手順を文書化

### 5️⃣ テスト
- [ ] 5-1.**単体テスト**
    - [ ] 5-1-1.各ユーティリティ関数が正しく動作することを確認
- [ ] 5-2.**結合テスト**
    - [ ] 5-2-1.**正常系**: 複数役職の入社者データで、カレンダー招待とステータス更新が正しく行われることを確認
    - [ ] 5-2-2.**異常系**: 不正なデータ（存在しない役職、不正なメールアドレス等）でエラーが記録され、他の処理が続行されることを確認

### 6️⃣ 今後の拡張（オプション）
- [ ] 6-1.人事システムとのAPI連携の調査・検討
- [ ] 6-2.研修リマインダーメールの自動送信機能の実装
- [ ] 6-3.Slackなどチャットツールへの通知機能の実装 

## TODO リスト

### カレンダー関連
- ☒ カレンダー関連コードの現状分析
- ☒ 実施順管理の問題点を特定（原因：calculateSequenceBasedStartTimeのロジックエラー）
- ☒ CalendarUtils.gsのリファクタリング設計
- ☒ リファクタリング実装（基本クラス作成完了）
- ☐ 実施順問題の修正テスト
- ☐ 新旧システムの切り替え
- ☐ 統合テスト

### リファクタリング済み構成
✅ **CalendarUtils_Refactored.gs** を新規作成し、以下の責任分離を実現：

1. **SequenceManager** (実施順管理)
   - 実施順を厳密に管理
   - 直前の研修終了時刻から連続スケジューリング
   - デバッグログで可視化

2. **TimeSlotCalculator** (時間枠計算)
   - 実施日計算
   - 実施順に基づく開始時間計算
   - 昼休み時間調整
   - 営業時間チェック

3. **RoomManager** (会議室管理)
   - 会議室予約システム
   - Googleカレンダー連携
   - ハイブリッド開催対応

4. **CalendarEventManager** (カレンダー操作)
   - イベント作成
   - イベント削除
   - 全体調整

### 問題修正点
🚨 **実施順問題の根本原因を修正済み**：
- 直前の実施順研修の終了時刻から即座に開始するロジックを実装
- SequenceManagerによる厳密な実施順管理
- デバッグログの充実で問題を可視化

### 次のステップ
1. **テスト実行**: 新システムで3番目・4番目の研修が正しい時間（18:00以降）にスケジュールされるかテスト
2. **段階的移行**: 従来システムから新システムへの移行
3. **本格運用**: 問題なければ従来版を非推奨化

### その他
- ☒ 「範囲の列数には1以上を指定してください」エラーを修正
- ☒ 研修管理表マスタのM,P列削除に対応
- ☒ マッピングシートにエラー詳細列を追加
- ☒ 行更新機能を実装 